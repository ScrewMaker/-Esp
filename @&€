--[[
    WARNING: Heads up! This script has not been verified by ScriptBlox. Use at your own risk!
]]
if (not _G.Flags) then
    _G.Flags = {
        ESP = {
            NotVisibleColor = Color3.fromRGB(255,0,0);
            VisibleColor = Color3.fromRGB(0,255,0);
            DistanceLimit = 1500;
            Box = false;
            Name = true;
            Weapon = true;
            Distance = true;
            VisibleCheck = true;
        };
    };
end

if (not _G.Loaded) then
    _G.Loaded = true;
    local RunService = game:GetService("RunService");
    local CoreGui = game:GetService("CoreGui");
    local CurrentCamera = workspace.CurrentCamera;
    local IgnoreFolder = workspace:WaitForChild("Ignore");
    
    function CreateESP()
        local BillboardGui = Instance.new("BillboardGui")
        local Box = Instance.new("Frame")
        local PlayerName = Instance.new("TextLabel")
        local PlayerWeapon = Instance.new("TextLabel")
        local PlayerDistance = Instance.new("TextLabel")
        local UIStroke = Instance.new("UIStroke")
        
        BillboardGui.Parent = CoreGui;
        BillboardGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
        BillboardGui.AlwaysOnTop = true
        BillboardGui.LightInfluence = 1.000
        BillboardGui.Size = UDim2.new(500, 0, 800, 0)

        Box.Name = "Box"
        Box.Parent = BillboardGui
        Box.BackgroundTransparency = 1.000
        Box.BorderSizePixel = 0
        Box.Size = UDim2.new(0.00899999961, 0, 0.00899999961, 0)

        UIStroke.Parent = Box;
        UIStroke.Thickness = 1;
        UIStroke.Color = Color3.fromRGB(0,255,0);

        PlayerName.Name = "PlayerName"
        PlayerName.Parent = BillboardGui
        PlayerName.BackgroundTransparency = 1.010
        PlayerName.Size = UDim2.new(0, 100, 0, 10)
        PlayerName.Font = Enum.Font.SourceSans
        PlayerName.Text = "Player"
        PlayerName.TextColor3 = Color3.fromRGB(0, 255, 8)
        PlayerName.TextSize = 14.000

        PlayerWeapon.Name = "PlayerWeapon"
        PlayerWeapon.Parent = BillboardGui
        PlayerWeapon.BackgroundTransparency = 1.010
        PlayerWeapon.Size = UDim2.new(0, 100, 0, 10)
        PlayerWeapon.Font = Enum.Font.SourceSans
        PlayerWeapon.Text = "Weapon"
        PlayerWeapon.TextColor3 = Color3.fromRGB(0, 255, 8)
        PlayerWeapon.TextSize = 14.000
        PlayerWeapon.Visible = false;

        PlayerDistance.Name = "PlayerDistance"
        PlayerDistance.Parent = BillboardGui
        PlayerDistance.BackgroundTransparency = 1.010
        PlayerDistance.Size = UDim2.new(0, 100, 0, 10)
        PlayerDistance.Font = Enum.Font.SourceSans
        PlayerDistance.Text = "500"
        PlayerDistance.TextColor3 = Color3.fromRGB(0, 255, 8)
        PlayerDistance.TextSize = 14.000

        return BillboardGui;
    end
    
    function SetColor(Billboard,Color) 
        Billboard.PlayerName.TextColor3 = Color;
        Billboard.PlayerDistance.TextColor3 = Color;
        Billboard.PlayerWeapon.TextColor3 = Color;
        Billboard.Box.UIStroke.Color = Color;
    end
    
    local HasESP = {};
    RunService.Heartbeat:Connect(function()
        local ESP =  _G.Flags.ESP;
        for i,v in pairs(workspace:GetChildren()) do
            if (HasESP[v] == nil and v:IsA("Model") and v:FindFirstChild("Head") and v.PrimaryPart~=nil) then
                local Billboard = CreateESP();
                HasESP[v] = Billboard;
                Billboard.Adornee = v.PrimaryPart;
            elseif (HasESP[v] ~= nil) then
                local Billboard = HasESP[v];
                local PrimaryPosition = v.PrimaryPart.Position;
                local Origin = CurrentCamera.CFrame.Position;
                local Distance = (Origin-PrimaryPosition).Magnitude;
                
                if (Distance > ESP.DistanceLimit) then
                    Billboard.Enabled = false;
                    continue;
                end

                Billboard.Enabled = true;
                Billboard.Adornee = v.PrimaryPart;

                Billboard.Box.Visible = ESP.Box;
                Billboard.PlayerDistance.Visible = ESP.Distance;
                Billboard.PlayerName.Visible = ESP.Name;
                Billboard.PlayerWeapon.Visible = ESP.Weapon;

                Billboard.PlayerDistance.Text = math.round(Distance) .. "s";
                
                local Params = RaycastParams.new();
                Params.FilterDescendantsInstances = {IgnoreFolder,v};
                local Direction = PrimaryPosition - Origin;
                local Raycast = workspace:Raycast(Origin,Direction,Params);
                SetColor(Billboard, if (not Raycast or not ESP.VisibleCheck) then ESP.VisibleColor else ESP.NotVisibleColor);
            end	
        end
    end)
end
